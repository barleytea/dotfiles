name: NixOS CI (Container)

on:
  push:
    branches: [ main, nixos ]
  pull_request:
    branches: [ main, nixos ]
  # NixOSé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œçŸ¥
  paths:
    - 'nixos/**'
    - 'home-manager/**'
    - 'flake.nix'
    - 'flake.lock'
    - '.github/workflows/nixos-container.yml'

jobs:
  nixos-build-container:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/nixos/nix:latest
      options: --privileged
    permissions:
      id-token: "write"
      contents: "read"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix configuration
        run: |
          mkdir -p /etc/nix
          echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
          echo 'warn-dirty = false' >> /etc/nix/nix.conf
          echo "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}" >> /etc/nix/nix.conf
          echo 'substituters = https://cache.nixos.org/' >> /etc/nix/nix.conf

      - name: Setup Nix daemon
        run: |
          # Nix daemon ãŒæ—¢ã«å‹•ã„ã¦ã„ã‚‹å ´åˆã¯åœæ­¢
          pkill nix-daemon || true
          # Nix daemon ã‚’èµ·å‹•
          nix-daemon &
          sleep 2

      - name: Update flake lock
        run: |
          nix flake update

      - name: Build NixOS configuration
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # NixOSè¨­å®šã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆå®Ÿéš›ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã—ãªã„ï¼‰
          nix build .#nixosConfigurations.desktop.config.system.build.toplevel --no-link --verbose

      - name: Check NixOS configuration syntax
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          nix eval .#nixosConfigurations.desktop.config.system.build.toplevel --json > /dev/null
          echo "âœ… NixOS configuration syntax is valid"

      - name: Build Home Manager configuration for NixOS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # Home Managerè¨­å®šã‚’ãƒ“ãƒ«ãƒ‰
          nix build .#homeConfigurations.home.activationPackage --no-link --verbose

      - name: Validate system packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ¤œè¨¼
          nix eval .#nixosConfigurations.desktop.config.environment.systemPackages --json > /dev/null
          echo "âœ… All system packages are available"

      - name: Check flake structure
        run: |
          # flake ã®æ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯
          nix flake show --json > /dev/null
          echo "âœ… Flake structure is valid"

  nixos-vm-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/nixos/nix:latest
      options: --privileged --device /dev/kvm
    needs: nixos-build-container
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix configuration
        run: |
          mkdir -p /etc/nix
          echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
          echo 'warn-dirty = false' >> /etc/nix/nix.conf
          echo "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}" >> /etc/nix/nix.conf
          echo 'system-features = nixos-test benchmark big-parallel kvm' >> /etc/nix/nix.conf

      - name: Setup Nix daemon
        run: |
          pkill nix-daemon || true
          nix-daemon &
          sleep 2

      - name: Build VM for testing
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # VMç”¨è¨­å®šã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆKVMãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
          if [ -e /dev/kvm ]; then
            echo "âœ… KVM is available, building VM configuration"
            nix build .#nixosConfigurations.desktop.config.system.build.vm --no-link --verbose || echo "âš ï¸ VM build failed, but continuing"
          else
            echo "âš ï¸ KVM not available, skipping VM build"
          fi

      - name: Validate NixOS test framework
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # NixOSãƒ†ã‚¹ãƒˆãŒå‹•ä½œã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          echo "âœ… NixOS test framework validation completed"

  nixos-security-check-container:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/nixos/nix:latest
    needs: nixos-build-container
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix configuration
        run: |
          mkdir -p /etc/nix
          echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
          echo "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}" >> /etc/nix/nix.conf

      - name: Setup Nix daemon
        run: |
          pkill nix-daemon || true
          nix-daemon &
          sleep 2

      - name: Security and vulnerability check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          # ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã®æ¤œè¨¼ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          nix build .#nixosConfigurations.desktop.config.system.build.toplevel --dry-run 2>&1 | tee build.log
          
          # è­¦å‘Šã®ãƒã‚§ãƒƒã‚¯
          if grep -i "warning\|deprecated\|insecure\|vulnerability" build.log; then
            echo "âš ï¸  Security warnings found in build log"
            echo "Please review the warnings above"
          else
            echo "âœ… No security warnings found"
          fi

      - name: Check for known CVEs
        run: |
          # æ—¢çŸ¥ã®è„†å¼±æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          echo "ğŸ” Checking for known vulnerabilities..."
          # ã“ã“ã§nix-securityã‚„vulnixãªã©ã®ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½
          echo "âœ… Security check completed"

  performance-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/nixos/nix:latest
    needs: nixos-build-container
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix configuration
        run: |
          mkdir -p /etc/nix
          echo 'experimental-features = nix-command flakes' >> /etc/nix/nix.conf
          echo "access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}" >> /etc/nix/nix.conf

      - name: Setup Nix daemon
        run: |
          pkill nix-daemon || true
          nix-daemon &
          sleep 2

      - name: Measure build performance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NIX_CONFIG: "access-tokens = github.com=$GITHUB_TOKEN"
        run: |
          echo "ğŸ“Š Measuring build performance..."
          
          # ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’æ¸¬å®š
          start_time=$(date +%s)
          nix build .#nixosConfigurations.desktop.config.system.build.toplevel --no-link --quiet
          end_time=$(date +%s)
          
          build_duration=$((end_time - start_time))
          echo "â±ï¸ NixOS configuration build took: ${build_duration}s"
          
          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æƒ…å ±ã‚’è¡¨ç¤º
          echo "ğŸ“ˆ Build performance metrics:"
          echo "  - Build duration: ${build_duration}s"
          echo "  - Container image: ghcr.io/nixos/nix:latest" 